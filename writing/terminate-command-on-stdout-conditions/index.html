<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Joel Kitching"><link rel="shortcut icon" href=https://joelkitching.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><link rel=canonical href=https://joelkitching.com/writing/terminate-command-on-stdout-conditions/><title>Terminating a command early on matching stdout conditions</title></head><body><header id=banner><h2><a href=https://joelkitching.com/>Joel Kitching</a></h2><nav><ul><li><a href=/ title>writing</a></li><li><a href=/about/ title>about</a></li><li><a href=https://github.com/jkitching title>github</a></li><li><a href=https://www.linkedin.com/in/joelkitching title>linkedin</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Terminating a command early on matching stdout conditions</h1><div><time>March 25, 2024</time></div></header><h1 id=match-and-exit>Match and exit</h1><p>This <a href=https://unix.stackexchange.com/questions/679658/kill-process-once-it-produces-certain-output>StackExchange question</a> provides a snippet which runs a subprocess, saves its PID, and then ends the process when a certain output string is encountered in its output.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sh -c <span class=s1>&#39;echo &#34;$$&#34;; exec stdbuf -oL &#34;$0&#34; &#34;$@&#34;&#39;</span> my-program with its args <span class=p>|</span> <span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=nv>IFS</span><span class=o>=</span> <span class=nb>read</span> -r pid <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    sed <span class=s1>&#39;/Was exported to:/q&#39;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nb>kill</span> -s PIPE <span class=s2>&#34;</span><span class=nv>$pid</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span></code></pre></div><h1 id=match-and-exit-with-short-circuit>Match and exit, with short-circuit</h1><p>I encountered a situation in which I wanted to exit early when it was determined that the matching condition would never be met.</p><p>The output of <code>my-program</code> is a list of newline-separated JSON objects, so each line needs to be processed individually, checking these two conditions:</p><ol><li>Success, which should output the entire line (matching JSON object)</li><li>Short-circuit failure, which should not output any text (no match)</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sh -c <span class=s1>&#39;echo &#34;$$&#34;; exec stdbuf -oL &#34;$0&#34; &#34;$@&#34;&#39;</span> my-program with its args <span class=p>|</span> <span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nv>IFS</span><span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nb>read</span> -r pid
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>read</span> -r line<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=c1># Break when the condition occurs, and output the matching JSON object</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span> <span class=p>|</span> jq -e <span class=s2>&#34;select(.key == \&#34;value\&#34;)&#34;</span> &gt; /dev/null<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nb>break</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=c1># Break when it is determined that the condition cannot be met</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> ! <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span> <span class=p>|</span> jq -e <span class=s2>&#34;select(.key == \&#34;value\&#34;)&#34;</span> &gt; /dev/null<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nb>break</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>    <span class=nb>kill</span> -s PIPE <span class=s2>&#34;</span><span class=nv>$pid</span><span class=s2>&#34;</span> 2&gt;/dev/null
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span></code></pre></div><p>Here, <code>jq</code>&rsquo;s <code>-e</code> flag will set a failing exit status if the <code>select()</code> function fails.</p><p>To output the JSON object in the matching case, <code>echo "$line"</code> is run before breaking out of the loop.</p><h1 id=shorter-conditionals-with-logical-operators>Shorter conditionals with logical operators</h1><p>We can also shorten the conditionals by taking advantage of the fact that <code>select()</code> will output the matching object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Break when the condition occurs, and output the matching JSON object</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span> <span class=p>|</span> jq -ce <span class=s2>&#34;select(.key == \&#34;value\&#34;)&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>break</span>
</span></span><span class=line><span class=cl><span class=c1># Break when it is determined that the condition cannot be met</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span> <span class=p>|</span> jq -e <span class=s2>&#34;select(.key == \&#34;value\&#34;)&#34;</span> &gt; /dev/null <span class=o>||</span> <span class=nb>break</span>
</span></span></code></pre></div><p><code>jq</code>&rsquo;s <code>-c</code> flag ensures that the matching object is printed on one line. The matching case no longer redirects to <code>/dev/null</code> since we want the output, and the <code>!</code> negation in the short-circuit case results in using a logical <code>||</code> instead of <code>&&</code>.</p></article></main><footer id=footer>Copyright © 2022–2024 Joel Isaac Stewart Davies-Kitching</footer></body></html>