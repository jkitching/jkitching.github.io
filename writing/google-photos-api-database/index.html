<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Joel Kitching"><link rel="shortcut icon" href=https://joelkitching.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><link rel=canonical href=https://joelkitching.com/writing/google-photos-api-database/><title>Creating a JSON database of photos and albums using Google Photos API</title></head><body><header id=banner><h2><a href=https://joelkitching.com/>Joel Kitching</a></h2><nav><ul><li><a href=/ title>writing</a></li><li><a href=/about/ title>about</a></li><li><a href=https://github.com/jkitching title>github</a></li><li><a href=https://www.linkedin.com/in/joelkitching title>linkedin</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Creating a JSON database of photos and albums using Google Photos API</h1><div><time>March 12, 2024</time></div></header><p>It turns out that using the Google Photos API is <a href=https://joelkitching.com/writing/google-photos-api-limitations/>not particularly suited</a> to organizing your photos collection. On the other hand, the API makes it easy to create a listing of all photos and albums in your collection.</p><p>For the case of creating a simple file-based JSON database, I wanted a command-line driven solution, so I used <a href=https://github.com/Byron/google-apis-rs/tree/main/gen/photoslibrary1-cli>photoslibrary1-cli</a>.</p><h1 id=authentication>Authentication</h1><p>The photoslibrary1-cli <a href=https://byron.github.io/google-apis-rs/google_photoslibrary1_cli/index.html>documentation</a> claims to include a client secrets file for public use, but it no longer works.</p><p>Instead, <a href=https://support.google.com/cloud/answer/6158849>you will need to create your own</a>:</p><ol><li>Set up a project on Google Cloud Console</li><li>Enable the Google Photos API</li><li>Choose the type of credentials to create (I used OAuth 2.0)</li><li>Download a JSON client secrets file</li></ol><p>Then, copy your client secrets file into <code>./google-service-cli/photoslibrary1-secret.json</code>, and authenticate with the browser (if using OAuth 2.0) by running any photoslibrary1-cli command, e.g. <code>photoslibrary1 media-items list</code>:</p><blockquote><p>Please direct your browser to [URL] and follow the instructions displayed there.</p></blockquote><h1 id=pagination>Pagination</h1><p>photoslibrary1-cli does not handle pagination, so I wrote <a href=https://gist.github.com/jkitching/236f62745c00a8d0578759e12b3f4502>photoslibrary1_paginated.sh</a> to do the extra bookkeeping.</p><p>It takes four arguments:</p><ol><li><code>--target-array</code>: The property name which stores the list of results for the given request. <code>mediaItems</code>, <code>albums</code>, or <code>sharedAlbums</code>.</li><li><code>--command</code>: The photoslibrary1-cli command to run. These are simply arguments forwarded directly to <code>photoslibrary1</code>.</li><li><code>--output-name</code>: The name of the file to which items will be concatenated is <code>&lt;output-name>.json</code>.</li><li><code>--page-token-arg</code>: I believe this may be a quirk of the way photoslibrary1-cli was written. Sometimes page tokens are provided as <code>-p page-token=&lt;page-token></code> and sometimes as <code>-r page-token=&lt;page-token></code>.</li></ol><p>Page token is saved as <code>&lt;output-name>.token</code>. The script can be safely interrupted with Ctrl+C. Just re-run with the same <code>--output-name</code> to resume.</p><h1 id=json-database-structure>JSON database structure</h1><p>This is how we plan to structure our database:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./media-items.json
</span></span><span class=line><span class=cl>./albums.json
</span></span><span class=line><span class=cl>./albums/ALBUM_ID.json
</span></span><span class=line><span class=cl>./shared-albums.json
</span></span><span class=line><span class=cl>./shared-albums/ALBUM_ID.json
</span></span><span class=line><span class=cl>./media-item-to-albums/MEDIA_ITEM_ID.json
</span></span><span class=line><span class=cl>./media-item-to-shared-albums/MEDIA_ITEM_ID.json
</span></span></code></pre></div><p>Each file contains one JSON object per line. Let&rsquo;s build up the database step-by-step.</p><h1 id=retrieve-a-list-of-media-items>Retrieve a list of media items</h1><p>Save information about each media item (photo or video) into <code>media-items.json</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./photoslibrary1_paginated.sh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --target-array mediaItems <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --command <span class=s1>&#39;media-items list&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --output-name media-items <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --page-token-arg p
</span></span></code></pre></div><h1 id=retrieve-a-list-of-albums>Retrieve a list of albums</h1><p>Albums that <strong>you created</strong> are listed here, even if they are shared with others. Save to <code>albums.json</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./photoslibrary1_paginated.sh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --target-array albums <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --command <span class=s1>&#39;albums list&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --output-name albums <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --page-token-arg p
</span></span></code></pre></div><h1 id=retrieve-a-list-of-shared-albums>Retrieve a list of shared albums</h1><p>Albums that <strong>others shared with you</strong> are listed here. Save to <code>shared-albums.json</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./photoslibrary1_paginated.sh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --target-array sharedAlbums <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --command <span class=s1>&#39;shared-albums list&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --output-name shared-albums <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --page-token-arg p
</span></span></code></pre></div><h1 id=retrieve-a-list-of-media-items-in-each-album>Retrieve a list of media items in each album</h1><p>For each album, retrieve a list of media items. Save to <code>albums/ALBUM_ID.json</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir albums
</span></span><span class=line><span class=cl><span class=k>for</span> album in <span class=sb>`</span>cat albums.json <span class=p>|</span> jq -r <span class=s1>&#39;.id&#39;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$album</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  ./photoslibrary1_paginated.sh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --target-array mediaItems <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --command <span class=s2>&#34;media-items search -r . album-id=</span><span class=nv>$album</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --output-name <span class=s2>&#34;albums/</span><span class=nv>$album</span><span class=s2>&#34;</span> --page-token-arg r
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><h1 id=retrieve-a-list-of-media-items-in-each-shared-album>Retrieve a list of media items in each shared album</h1><p>For each shared album, retrieve a list of media items. Save to <code>shared-albums/ALBUM_ID.json</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir shared-albums
</span></span><span class=line><span class=cl><span class=k>for</span> album in <span class=sb>`</span>cat shared-albums.json <span class=p>|</span> jq -r <span class=s1>&#39;.id&#39;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$album</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  ./photoslibrary1_paginated.sh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --target-array mediaItems <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --command <span class=s2>&#34;media-items search -r . album-id=</span><span class=nv>$album</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --output-name <span class=s2>&#34;shared-albums/</span><span class=nv>$album</span><span class=s2>&#34;</span> --page-token-arg r
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><h1 id=map-media-items-to-albums-containing-them>Map media items to albums containing them</h1><p>For each media item, if one or more albums contain the media item, create a file listing those albums. Save to <code>media-item-to-albums/MEDIA_ITEM_ID.json</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir media-item-to-albums
</span></span><span class=line><span class=cl><span class=k>for</span> fname in albums/*.json<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nv>album_id</span><span class=o>=</span><span class=sb>`</span><span class=nb>echo</span> <span class=nv>$fname</span> <span class=p>|</span> sed -e <span class=s1>&#39;s@\.json$@@&#39;</span> -e <span class=s1>&#39;s@^albums/@@&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$album_id</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> media_id in <span class=sb>`</span>cat <span class=nv>$fname</span> <span class=p>|</span> jq -r <span class=s1>&#39;.id&#39;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    touch <span class=s2>&#34;media-item-to-albums/</span><span class=si>${</span><span class=nv>media_id</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>    grep <span class=s2>&#34;</span><span class=nv>$album_id</span><span class=s2>&#34;</span> albums.json &gt;&gt; <span class=s2>&#34;media-item-to-albums/</span><span class=si>${</span><span class=nv>media_id</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><h1 id=map-media-items-to-shared-albums-containing-them>Map media items to shared albums containing them</h1><p>For each media item, if one or more shared albums contain the media item, create a file listing those albums. Save to <code>media-item-to-shared-albums/MEDIA_ITEM_ID.json</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir media-item-to-shared-albums
</span></span><span class=line><span class=cl><span class=k>for</span> fname in shared-albums/*.json<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nv>album_id</span><span class=o>=</span><span class=sb>`</span><span class=nb>echo</span> <span class=nv>$fname</span> <span class=p>|</span> sed -e <span class=s1>&#39;s@\.json$@@&#39;</span> -e <span class=s1>&#39;s@^shared-albums/@@&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$album_id</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> media_id in <span class=sb>`</span>cat <span class=nv>$fname</span> <span class=p>|</span> jq -r <span class=s1>&#39;.id&#39;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    touch <span class=s2>&#34;media-item-to-shared-albums/</span><span class=si>${</span><span class=nv>media_id</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>    grep <span class=s2>&#34;</span><span class=nv>$album_id</span><span class=s2>&#34;</span> shared-albums.json &gt;&gt; <span class=s2>&#34;media-item-to-shared-albums/</span><span class=si>${</span><span class=nv>media_id</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><p>And that&rsquo;s all!</p></article></main><footer id=footer>Copyright © 2022–2024 Joel Isaac Stewart Davies-Kitching</footer></body></html>