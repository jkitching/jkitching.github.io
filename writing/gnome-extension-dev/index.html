<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Joel Kitching"><link rel="shortcut icon" href=https://joelkitching.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><link rel=canonical href=https://joelkitching.com/writing/gnome-extension-dev/><title>A brief foray into GNOME extension development</title></head><body><header id=banner><h2><a href=https://joelkitching.com/>Joel Kitching</a></h2><nav><ul><li><a href=/ title>writing</a></li><li><a href=/about/ title>about</a></li><li><a href=https://github.com/jkitching title>github</a></li><li><a href=https://www.linkedin.com/in/joelkitching title>linkedin</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>A brief foray into GNOME extension development</h1><div><time>November 26, 2022</time></div></header><p>I used to be an exclusive user of tiling window managers, namely: <a href=https://xmonad.org/>xmonad</a>. When I converted over to the GNOME world, I tried all of the window tiling extensions and settled on the excellent <a href=https://github.com/paperwm/PaperWM>PaperWM</a>. But PaperWM, as with most GNOME extensions, struggled to keep up with the rapid pace of GNOME releases, and I was stuck on vanilla GNOME for some time.</p><p>Recently, Arch pushed the GNOME 43 release, and, surprise! I lost another extension that I have come to love: Philippe Troin&rsquo;s <a href=https://github.com/F-i-f/soft-brightness>Soft Brightness</a>. This extension takes the existing brightness control in GNOME, and extends the darkest setting past the limits of the physical display by adjusting gamma settings. (In other words, it prevents you from going blind when working in a dark room.) There was an <a href=https://github.com/F-i-f/soft-brightness/issues/58>open issue for GNOME 43 support</a> on the Soft Brightness GitHub page, but before I wrote this post, no progress had yet been made. Rather than downgrading GNOME and waiting patiently, I decided to take matters into my own hands.</p><p><img src=soft-brightness-settings.png alt="Settings dialog of GNOME Soft Brightness extension"></p><h1 id=update-metadatajson-and-hope-for-the-best>Update <code>metadata.json</code> and hope for the best</h1><p>First of all, let&rsquo;s clone the Soft Brightness repository, and update <code>metadata.json</code> to claim support for GNOME 43.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gh>diff --git a/src/metadata.json.in b/src/metadata.json.in
</span></span></span><span class=line><span class=cl><span class=gh>index e4af9c3..33595f6 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/src/metadata.json.in
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/metadata.json.in
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -12,7 +12,8 @@
</span></span></span><span class=line><span class=cl><span class=gu></span>     &#34;3.38&#34;,
</span></span><span class=line><span class=cl>     &#34;40&#34;,
</span></span><span class=line><span class=cl>     &#34;41&#34;,
</span></span><span class=line><span class=cl><span class=gd>-    &#34;42&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+    &#34;42&#34;,
</span></span></span><span class=line><span class=cl><span class=gi>+    &#34;43&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span>   ],
</span></span><span class=line><span class=cl>   &#34;url&#34;: &#34;https://github.com/F-i-f/soft-brightness&#34;,
</span></span><span class=line><span class=cl>   &#34;uuid&#34;: &#34;@uuid@&#34;,
</span></span></code></pre></div><p>The documentation shows the incantation to build and install the extension: <code>meson build && ninja -C build install</code>. Great! Let&rsquo;s re-enable the extension and see what happens.</p><p><img src=extensions-error.png alt="Soft Brightness extension encounters an error when enabled"></p><p>Okay&mldr; so that didn&rsquo;t work very well. There&rsquo;s something wrong with AggregateMenu. Coincidentally, the guide for <a href=https://gjs.guide/extensions/upgrading/gnome-shell-43.html#quick-settings>porting extensions to GNOME 43</a> mentions that AggregateMenu has been replaced with QuickSettings. No problem! We just need to search-and-replace a few strings, and the extension is ready for action. But&mldr; seems like there&rsquo;s no way to &ldquo;reload&rdquo; the extension in a running GNOME session.</p><h1 id=reload-gnome-extensions>Reload GNOME extensions</h1><p>GNOME might not allow reloading extensions dynamically, but there is a simple workaround: reload <code>gnome-shell</code> instead. For all of you X11 users, go ahead and press Alt+F2 right now, type the <code>r</code> command, and hit &lt;Enter>. Tah-dah! For all of you Wayland users&mldr; I feel your pain.</p><p><img src=run-command.png alt="GNOME Run Command dialog"></p><p>Whereas X11 architecture separates the X server (e.g. Xorg) from the compositor (e.g. Mutter or <code>gnome-shell</code>), Wayland architecture merges the two, and <code>gnome-shell</code> also takes on the equivalent role of an X server. <a href=https://wayland.freedesktop.org/docs/html/ch03.html#sect-Wayland-Architecture-wayland_architecture>(More reading for those interested.)</a> Thus, reloading <code>gnome-shell</code> in Wayland effectively brings down the entire session along with all of your running applications.</p><p><figure><img src=x-architecture.png alt="X11 architecture diagram"><figcaption>In Wayland, (4) X Server and (5) Compositor are merged.</figcaption></figure></p><p>Apparently it&rsquo;s pretty easy to run a nested <code>gnome-shell</code> in Wayland, but it seems to have a lot of strange issues. For example, opening up most applications from the nested window results in them being opened in&mldr; the parent <code>gnome-shell</code>. Huh? Also, there is no brightness control in the nested window, which is pretty important if we are to get Soft Brightness working. So&mldr; until we figure out <a href=/writing/x11docker-gnome-containers/>how to get containers involved</a>, I&rsquo;m sad to say that the easiest route is to temporarily switch over to an X11 session.</p><h1 id=set-up-the-development-environment>Set up the development environment</h1><p>Once there, we can get our development workflow going:</p><ol><li>Make changes to the extension source code</li><li><code>ninja -C build install</code></li><li>Alt+F2, <code>r</code> &lt;Enter></li><li>Close and re-open <code>gnome-extensions-app</code></li><li>Attempt to enable extension</li></ol><p><img src=dev-workflow.png alt="GNOME development workflow screenshot"></p><p>Or for those who enjoy stringing commands together and avoiding tinkering with the UI:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ gnome-extensions disable soft-brightness@fifi.org <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ninja -C build install <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    killall -HUP gnome-shell <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    sleep <span class=m>3</span> <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    gnome-extensions <span class=nb>enable</span> soft-brightness@fifi.org
</span></span></code></pre></div><p>Sometimes the one-line error provided by <code>gnome-extensions-app</code> is enough to track down the latest error. But we can get more information (a full stack trace) by watching <code>gnome-shell</code> logs while reloading extensions. On a systemd-based distribution, that amounts to running <code>journalctl -f _COMM=gnome-shell</code>.</p><h1 id=explore-with-looking-glass>Explore with Looking Glass</h1><p>I quickly discovered that <code>s/AggregateMenu/QuickSettings/g</code> wasn&rsquo;t going to cut it. My heart yearned for Chrome Developer Tools, which lets you click a UI element to inspect its properties and position in the DOM. And then the heavenly words appeared, glowing softly in my Google search results: <a href=https://wiki.gnome.org/Projects/GnomeShell/LookingGlass>Looking Glass</a>. Although nowhere near as advanced as Developer Tools, it allows us to inspect the JavaScript world of a running instance of <code>gnome-shell</code>, and interactively make modifications.</p><p>Looking Glass is accessible via Alt+F2 and then <code>lg</code>. Honestly, it&rsquo;s somewhat frustrating to use, since it blocks interaction with the UI until closed with &lt;Esc>. But for our purposes, it should be more than sufficient.</p><p><img src=looking-glass.png alt="Looking Glass dialog"></p><p>To familiarize ourselves with QuickSettings, let&rsquo;s see if we can remove the brightness indicator. In order to figure out the correct set of instructions, we refer to (1) existing Soft Brightness code, (2) the commit used to convert the brightness indicator over to QuickSettings (<a href=https://gitlab.gnome.org/GNOME/gnome-shell/-/commit/7bbd59838a6cfe14b189fa7bd8e743fb0cac9bc3>status/brightness: Port to quick settings</a>), and (3) an extension for customizing QuickSettings (<a href=https://github.com/qwreey75/quick-settings-tweaks/blob/e7eab279bbe2cfaeb59a7068808166ac7c5c046d/features/dndQuickToggle.js>Quick Settings Tweaker</a>). We lather liberally with trial and error, and come out with this JavaScript sequence:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>QS</span> <span class=o>=</span> <span class=nx>imports</span><span class=p>.</span><span class=nx>ui</span><span class=p>.</span><span class=nx>main</span><span class=p>.</span><span class=nx>panel</span><span class=p>.</span><span class=nx>statusArea</span><span class=p>.</span><span class=nx>quickSettings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>b</span> <span class=o>=</span> <span class=nx>QS</span><span class=p>.</span><span class=nx>_settings</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>bi</span> <span class=o>=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>quickSettingsItems</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>bi</span><span class=p>.</span><span class=nx>_proxy</span><span class=p>.</span><span class=nx>run_dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>bi</span><span class=p>.</span><span class=nx>get_parent</span><span class=p>().</span><span class=nx>remove_child</span><span class=p>(</span><span class=nx>bi</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>.</span><span class=nx>get_parent</span><span class=p>().</span><span class=nx>remove_child</span><span class=p>(</span><span class=nx>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>b</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span>
</span></span></code></pre></div><p><img src=quick-settings-no-brightness.png alt="QuickSettings without brightness indicator"></p><p>And&mldr; it&rsquo;s gone! Well, that&rsquo;s rather satisfying, but slightly awkward. Let&rsquo;s reload <code>gnome-shell</code> to get it back. (Again, sorry Wayland users!)</p><h1 id=current-strategy-used-by-soft-brightness>Current strategy used by Soft Brightness</h1><p>In current Soft Brightness code, the brightness indicator class is extended, and functions are overridden to serve the extension&rsquo;s needs. When the extension is enabled, the modified class is instantiated, and the existing brightness indicator is swapped out with the modified one:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Indicator</span> <span class=o>=</span> <span class=nx>imports</span><span class=p>.</span><span class=nx>ui</span><span class=p>.</span><span class=nx>status</span><span class=p>.</span><span class=nx>brightness</span><span class=p>.</span><span class=nx>Indicator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ModifiedBrightnessIndicator</span> <span class=kr>extends</span> <span class=nx>Indicator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>_sliderChanged</span><span class=p>(</span><span class=nx>slider</span><span class=p>)</span> <span class=p>{</span> <span class=p>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>_sync</span><span class=p>()</span> <span class=p>{</span> <span class=p>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It turns out that in the process of converting the brightness indicator to QuickSettings <a href=https://gitlab.gnome.org/GNOME/gnome-shell/-/commit/7bbd59838a6cfe14b189fa7bd8e743fb0cac9bc3#e220cd54002c151792a62cbc832b05dd3ad65ad0_20_16>(GitLab commit)</a>, the <code>Indicator</code> class was renamed, made private, and hidden behind a wrapper class called <code>SystemIndicator</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Class is private to this module and not exported
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>BrightnessItem</span> <span class=kr>extends</span> <span class=nx>QuickSlider</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>_sliderChanged</span><span class=p>(</span><span class=nx>slider</span><span class=p>)</span> <span class=p>{</span> <span class=p>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>_sync</span><span class=p>()</span> <span class=p>{</span> <span class=p>...</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Class is exported as imports.ui.status.brightness.Indicator
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>Indicator</span> <span class=kr>extends</span> <span class=nx>SystemIndicator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>_init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>quickSettingsItems</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=k>new</span> <span class=nx>BrightnessItem</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Rather than completely re-implementing the new <code>BrightnessItem</code> class and dealing with spaghetti code for handling <code>gnome-shell</code> 42/43 differences, we take a different approach: monkey patching.</p><h1 id=monkey-patching-the-brightness-indicator>Monkey patching the brightness indicator</h1><p>Although monkey patching is generally frowned upon, it can be useful in an environment where extensibility is limited.</p><p>Instead of swapping out a completely new brightness indicator object, we keep the existing brightness indicator in tact, but modify its behaviour while the Soft Brightness extension is enabled.</p><p>We implement two functions to perform the monkey patching and restoration when the extension is disabled, taking care to <strong><code>bind()</code></strong> our function&rsquo;s <code>this</code> variable to the indicator object itself:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>_enableBrightnessIndicatorPatch</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>indicator</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>_brightnessIndicator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>indicator</span><span class=p>.</span><span class=nx>__orig__slider_changed</span> <span class=o>=</span> <span class=nx>indicator</span><span class=p>.</span><span class=nx>_slider_changed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>indicator</span><span class=p>.</span><span class=nx>_slider_changed</span> <span class=o>=</span> <span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span> <span class=p>...</span> <span class=p>}).</span><span class=nx>bind</span><span class=p>(</span><span class=nx>indicator</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>_disableBrightnessIndicatorPatch</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>indicator</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>_brightnessIndicator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>indicator</span><span class=p>.</span><span class=nx>setSliderValue</span> <span class=o>=</span> <span class=nx>indicator</span><span class=p>.</span><span class=nx>__orig__setSliderValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=nx>indicator</span><span class=p>.</span><span class=nx>__orig_setSliderValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=trouble-with-brightnessproxy>Trouble with <code>BrightnessProxy</code></h1><p>This strategy works great. However, the extension exhibits some strange behaviour in GNOME 42 and below. It turns out that despite swapping out the <code>_sync</code> function, the Brightness proxy (used for setting and accessing system backlight brightness) still calls the old function! What&rsquo;s going on here?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>BrightnessItem</span> <span class=kr>extends</span> <span class=nx>QuickSlider</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>_init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>_proxy</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BrightnessProxy</span><span class=p>(...,</span> <span class=p>(</span><span class=nx>proxy</span><span class=p>,</span> <span class=nx>error</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>_proxy</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=s1>&#39;g-properties-changed&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=c1>// This _sync call is causing our headache.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>_sync</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This bit of code is <strong>exactly</strong> the same in both GNOME versions 42 and 43. Barring some part of the JS spec that I&rsquo;m missing (totally possible), the only natural conclusion is that there is some bug in how GNOME 42&rsquo;s JavaScript engine (SpiderMonkey) handles the &ldquo;this&rdquo; keyword w.r.t. arrow functions. <strong>If anyone <em>does</em> have some conclusive information, I would love to hear from you!</strong></p><p>Unfortunately, we can&rsquo;t change the proxy&rsquo;s callback function on-the-fly. So, our best course of action is to destroy and re-create the proxy, with a callback function that reliably calls the currently-used <code>_sync</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>indicator</span><span class=p>.</span><span class=nx>_proxy</span><span class=p>.</span><span class=nx>run_dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>indicator</span><span class=p>.</span><span class=nx>_proxy</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BrightnessProxy</span><span class=p>(...,</span> <span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>proxy</span><span class=p>,</span> <span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_proxy</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=s1>&#39;g-properties-changed&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>_sync</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nx>bind</span><span class=p>(</span><span class=nx>indicator</span><span class=p>));</span>
</span></span></code></pre></div><p>Note that we have to convert the function passed to <code>BrightnessProxy</code> to the form <code>(function(x, y) {...})</code> in order to call <strong><code>bind()</code></strong>. And this fixes our issue!</p><h1 id=clean-up-document-and-upload-changes>Clean up, document, and upload changes</h1><p>This is the most important part. I extensively document the problems encountered with <code>BrightnessProxy</code>, author a commit message explaining the rationale behind using monkey patching, and create a <a href=https://github.com/F-i-f/soft-brightness/pull/59>GitHub pull request</a>. And we&rsquo;re done!</p><p>There is one point that I conveniently glossed over: testing the GNOME extension in previous versions of GNOME&mldr; how did I do that? Let&rsquo;s look at GNOME containerization in the next post, <a href=/writing/x11docker-gnome-containers/>GNOME development with x11docker containers</a>.</p></article></main><footer id=footer>Copyright © 2022–2024 Joel Isaac Stewart Davies-Kitching</footer></body></html>